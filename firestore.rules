rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザーがログインしているかチェック
    function isSignedIn() {
      return request.auth != null;
    }
    
    // リソースのオーナーかチェック
    function isOwner(ownerId) {
      return isSignedIn() && request.auth.uid == ownerId;
    }
    
    // 共同編集者かチェック
    function isCollaborator(catData) {
      return isSignedIn() && (
        catData.collaborators != null &&
        (
          catData.collaborators.hasAny([request.auth.uid]) ||
          catData.collaborators.hasAny([request.auth.token.email])
        )
      );
    }
    
    // 猫のコレクション
    match /cats/{catId} {
      // 読み取り: shareTokenがある場合は誰でも、なければオーナーか共同編集者のみ
      allow read: if resource.data.shareToken != null || 
                     isOwner(resource.data.ownerId) || 
                     isCollaborator(resource.data);
      
      // 作成: ログインユーザーのみ、ownerIdは自分のuidのみ
      allow create: if isSignedIn() && 
                       request.resource.data.ownerId == request.auth.uid;
      
      // 更新: オーナーのみ
      allow update: if isOwner(resource.data.ownerId) &&
                       request.resource.data.ownerId == resource.data.ownerId;
      
      // 削除: オーナーのみ
      allow delete: if isOwner(resource.data.ownerId);
    }
    
    // 体重記録のコレクション
    match /weights/{weightId} {
      // 読み取り: 対応する猫のデータを取得してチェック
      allow read: if isSignedIn() && (
        exists(/databases/$(database)/documents/cats/$(resource.data.catId)) &&
        (
          get(/databases/$(database)/documents/cats/$(resource.data.catId)).data.shareToken != null ||
          isOwner(get(/databases/$(database)/documents/cats/$(resource.data.catId)).data.ownerId) ||
          isCollaborator(get(/databases/$(database)/documents/cats/$(resource.data.catId)).data)
        )
      );
      
      // 作成: 猫のオーナーか共同編集者のみ
      allow create: if isSignedIn() && (
        exists(/databases/$(database)/documents/cats/$(request.resource.data.catId)) &&
        (
          isOwner(get(/databases/$(database)/documents/cats/$(request.resource.data.catId)).data.ownerId) ||
          isCollaborator(get(/databases/$(database)/documents/cats/$(request.resource.data.catId)).data)
        )
      );
      
      // 更新: 猫のオーナーか共同編集者のみ
      allow update: if isSignedIn() && (
        exists(/databases/$(database)/documents/cats/$(resource.data.catId)) &&
        (
          isOwner(get(/databases/$(database)/documents/cats/$(resource.data.catId)).data.ownerId) ||
          isCollaborator(get(/databases/$(database)/documents/cats/$(resource.data.catId)).data)
        )
      );
      
      // 削除: 猫のオーナーか共同編集者のみ
      allow delete: if isSignedIn() && (
        exists(/databases/$(database)/documents/cats/$(resource.data.catId)) &&
        (
          isOwner(get(/databases/$(database)/documents/cats/$(resource.data.catId)).data.ownerId) ||
          isCollaborator(get(/databases/$(database)/documents/cats/$(resource.data.catId)).data)
        )
      );
    }
  }
}
